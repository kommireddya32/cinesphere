<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Details</title>
    <style>
        body { font-family: sans-serif; background-color: #141414; color: white; margin: 0; padding: 40px; }
        .movie-details-container { display: flex; max-width: 1000px; margin: auto; background-color: #222; border-radius: 10px; padding: 20px; }
        .poster img { max-width: 300px; border-radius: 8px; }
        .details { margin-left: 20px; flex-grow: 1; }
        .details h1 { margin-top: 0; }
        .genres span { background-color: #444; padding: 5px 10px; border-radius: 15px; margin-right: 5px; font-size: 14px; }
        .back-link { display: inline-block; margin-bottom: 20px; color: #00bfff; text-decoration: none; }
        .providers img { width: 50px; height: 50px; border-radius: 8px; margin-right: 10px; }
        
        .cast-container {
            display: flex;
            flex-wrap: wrap; 
            gap: 15px;
        }
        .cast-member {
            text-align: center;
            width: 100px;
        }
        .cast-member img { width: 100px; height: 150px; border-radius: 8px; object-fit: cover; }
        .cast-member p { margin: 5px 0 0 0; font-size: 14px; }
    </style>
</head>
<body>
    <a href="/" class="back-link">&larr; Back to Search</a>
    <div id="movie-details-container" class="movie-details-container">
        </div>

    <script>
        window.addEventListener('DOMContentLoaded', () => {
            const params = new URLSearchParams(window.location.search);
            const movieId = params.get('id');

            if (movieId) {
                // Use Promise.all to wait for all three API calls to finish
                Promise.all([
                    fetch(`/api/movies/${movieId}`).then(res => res.json()),
                    fetch(`/api/movies/${movieId}/providers`).then(res => res.json()),
                    fetch(`/api/movies/${movieId}/credits`).then(res => res.json())
                ])
                .then(([movie, providersData, creditsData]) => {
                    // Once all data is ready, build the page
                    displayMovieDetails(movie, providersData, creditsData);
                })
                .catch(error => {
                    console.error('Error fetching movie data:', error);
                    document.getElementById('movie-details-container').innerHTML = '<h2>Failed to load movie details.</h2>';
                });
            }
        });

        function displayMovieDetails(movie, providersData, creditsData) {
            const container = document.getElementById('movie-details-container');
            const posterUrl = movie.poster_path ? `https://image.tmdb.org/t/p/w500${movie.poster_path}` : '';
            const genresHtml = movie.genres.map(genre => `<span>${genre.name}</span>`).join('');

            // --- Find Streaming Providers ---
            let providersHtml = "<p>Streaming information not available.</p>";
            const usProviders = providersData.results.US;
            if (usProviders && usProviders.link && usProviders.flatrate) {
                providersHtml = usProviders.flatrate.map(provider => `
                    <a href="${usProviders.link}" target="_blank">
                        <img src="https://image.tmdb.org/t/p/w500${provider.logo_path}" alt="${provider.provider_name}" title="${provider.provider_name}">
                    </a>
                `).join('');
            }

            // --- Find Top Cast Members ---
            let castHtml = "<p>Cast information not available.</p>";
            if (creditsData.cast && creditsData.cast.length > 0) {
                const topCast = creditsData.cast.slice(0, 10); // Get top 10 actors
                castHtml = topCast.map(member => {
                    const profileUrl = member.profile_path ? `https://image.tmdb.org/t/p/w500${member.profile_path}` : 'https://via.placeholder.com/100x150';
                    const googleSearchUrl = `https://www.google.com/search?q=${encodeURIComponent(member.name)}`;
                    
                    return `
                        <a href="${googleSearchUrl}" target="_blank" style="text-decoration: none; color: white;">
                            <div class="cast-member">
                                <img src="${profileUrl}" alt="${member.name}">
                                <p><strong>${member.name}</strong></p>
                                <p>${member.character}</p>
                            </div>
                        </a>
                    `;
                }).join('');
            }
            
            // --- Build the final HTML ---
            container.innerHTML = `
                <div class="poster">
                    <img src="${posterUrl}" alt="${movie.title}">
                </div>
                <div class="details">
                    <h1>${movie.title} (${movie.release_date ? movie.release_date.substring(0, 4) : 'N/A'})</h1>
                    <p class="genres">${genresHtml}</p>
                    <h3>Overview</h3>
                    <p>${movie.overview}</p>
                    <p><strong>Rating:</strong> ${movie.vote_average ? movie.vote_average.toFixed(1) : 'N/A'} / 10</p>
                    <h3>Available On:</h3>
                    <div class="providers">${providersHtml}</div>
                    <h3>Top Cast:</h3>
                    <div class="cast-container">${castHtml}</div>
                </div>
            `;
        }
    </script>
</body>
</html>